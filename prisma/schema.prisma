generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                       String     @id @default(cuid())
  name                     String
  username                 String     @unique
  email                    String     @unique
  role                     UserRole   @default(USER)
  isVerified               Boolean    @default(false)
  password                 String
  status                   UserStatus @default(ACTIVE)
  avatarUrl                String?
  avatarPublicId           String?
  verificationToken        String?
  verificationTokenExpiry  DateTime?
  passwordResetToken       String?
  passwordResetTokenExpiry DateTime?
  createdAt                DateTime   @default(now())
  updatedAt                DateTime   @updatedAt

  organizations       Organization[]
  workspaces          Workspace[]
  projects          Project[]
  projectMembers    ProjectMember[]
  organizationMembers OrganizationMember[]
  workspaceMembers    WorkspaceMember[]
  organizationInvites OrganizationInvite[]
  workspaceInvites    WorkspaceInvite[]

  taskComments    TaskComment[]
  taskAttachments TaskAttachment[]

  assignedTasks       Task[]               @relation("AssignedTasks")
  createdTasks        Task[]               @relation("CreatedTasks")
}

model Organization {
  id           String   @id @default(cuid())
  name         String
  slug         String   @unique
  logoUrl      String?
  websiteUrl   String?
  description  String?
  contactEmail String?
  ownerId      String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  invites    OrganizationInvite[]
  owner      User                 @relation(fields: [ownerId], references: [id])
  members    OrganizationMember[]
  workspaces Workspace[]
}

model OrganizationMember {
  id             String   @id @default(cuid())
  userId         String
  organizationId String
  role           OrgRole  @default(MEMBER)
  joinedAt       DateTime @default(now())

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
}

model OrganizationInvite {
  id             String       @id @default(cuid())
  organizationId String
  email          String
  role           OrgRole      @default(MEMBER)
  token          String       @unique
  invitedById    String
  status         InviteStatus @default(PENDING)

  expiresAt  DateTime
  createdAt  DateTime  @default(now())
  acceptedAt DateTime?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invitedBy    User         @relation(fields: [invitedById], references: [id])
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

model Workspace {
  id             String   @id @default(cuid())
  name           String
  organizationId String
  slug           String   @unique
  iconUrl        String?
  description    String?
  ownerId        String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  owner          User              @relation(fields: [ownerId], references: [id])
  organization   Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  members        WorkspaceMember[]
  projects       Project[]
  tasks          Task[]
  invites        WorkspaceInvite[]
}

model WorkspaceMember {
  id          String        @id @default(cuid())
  userId      String
  workspaceId String
  role        WorkspaceRole @default(MEMBER)
  joinedAt    DateTime      @default(now())

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([userId, workspaceId])
}

model WorkspaceInvite {
  id             String       @id @default(cuid())
  workspaceId String
  email          String
  role           WorkspaceRole      @default(MEMBER)
  token          String       @unique
  invitedById    String
  status         InviteStatus @default(PENDING)

  expiresAt  DateTime
  createdAt  DateTime  @default(now())
  acceptedAt DateTime?

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  invitedBy    User         @relation(fields: [invitedById], references: [id])
}


model Project {
  id          String        @id @default(cuid())
  name        String
  description String?
  status      ProjectStatus @default(ACTIVE)

  workspaceId String
  ownerId     String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  owner     User      @relation(fields: [ownerId], references: [id])

  members ProjectMember[]
  tasks   Task[]
  taskCategories TaskCategory[]

  @@unique([workspaceId, name])
}

model ProjectMember {
  id        String        @id @default(cuid())
  projectId String
  userId    String
  role      ProjectRole  @default(MEMBER)
  joinedAt  DateTime     @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
}

model Task {
  id          String       @id @default(cuid())
  title       String
  description String?
  status      TaskStatus   @default(TODO)
  priority    TaskPriority @default(MEDIUM)
  deadline    DateTime?

  workspaceId  String  
  projectId    String
  assignedToId String?
  categoryId   String?
  createdById  String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  attachments TaskAttachment[]
  links       TaskLink[]
  comments    TaskComment[]

  workspace  Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project    Project?      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignedTo User?         @relation("AssignedTasks", fields: [assignedToId], references: [id])
  createdBy  User          @relation("CreatedTasks", fields: [createdById], references: [id])
  category   TaskCategory? @relation(fields: [categoryId], references: [id])
}


model TaskAttachment {
  id           String  @id @default(cuid())
  taskId       String
  name         String
  url          String
  type         String?
  size         Int?
  uploadedById String

  createdAt DateTime @default(now())

  task       Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  uploadedBy User @relation(fields: [uploadedById], references: [id])
}

model TaskLink {
  id     String  @id @default(cuid())
  taskId String
  title  String?
  url    String

  createdAt DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
}

model TaskComment {
  id      String @id @default(cuid())
  taskId  String
  userId  String
  content String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])
}

model TaskCategory {
  id          String   @id @default(cuid())
  projectId   String
  name        String
  color       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks     Task[]

  @@unique([projectId, name])
}

enum UserRole {
  USER
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  BANNED
}

enum OrgRole {
  OWNER
  ADMIN
  MEMBER
}

enum WorkspaceRole {
  OWNER
  ADMIN
  MEMBER
}

enum ProjectStatus {
  DRAFT        
  ACTIVE       
  ON_HOLD      
  BLOCKED      
  COMPLETED    
  ARCHIVED     
  CANCELED     
}

enum ProjectRole {
  OWNER
  ADMIN
  MEMBER
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  BLOCKED
  ON_HOLD
  DONE
  CANCELED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}
