generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                       String     @id @default(cuid())
  name                     String
  username                 String     @unique
  email                    String     @unique
  role                     UserRole   @default(USER)
  isVerified               Boolean    @default(false)
  password                 String
  status                   UserStatus @default(ACTIVE)
  avatarUrl                String?
  avatarPublicId           String?
  verificationToken        String?
  verificationTokenExpiry  DateTime?
  passwordResetToken       String?
  passwordResetTokenExpiry DateTime?
  createdAt                DateTime   @default(now())
  updatedAt                DateTime   @updatedAt

  organizations       Organization[]
  workspaces          Workspace[]
  projects            Project[]
  projectMembers      ProjectMember[]
  organizationMembers OrganizationMember[]
  workspaceMembers    WorkspaceMember[]
  organizationInvites OrganizationInvite[]
  workspaceInvites    WorkspaceInvite[]

  taskComments    TaskComment[]
  taskAttachments TaskAttachment[]

  assignedTasks Task[]         @relation("TaskAssignees")
  createdTasks  Task[]         @relation("CreatedTasks")
  auditLogs     AuditLog[]
  subscriptions Subscription[]
}

model AuditLog {
  id             String          @id @default(cuid())
  organizationId String?
  workspaceId    String?
  userId         String?
  action         AuditAction
  entityType     AuditEntityType
  entityId       String
  details        Json?
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime        @default(now())

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  workspace    Workspace?    @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
  user         User?         @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([workspaceId])
  @@index([userId])
}

model Organization {
  id           String   @id @default(cuid())
  name         String
  slug         String   @unique
  logoUrl      String?
  websiteUrl   String?
  description  String?
  contactEmail String?
  ownerId      String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  invites    OrganizationInvite[]
  owner      User                 @relation(fields: [ownerId], references: [id])
  members    OrganizationMember[]
  workspaces Workspace[]
  auditLogs  AuditLog[]
}

model OrganizationMember {
  id             String   @id @default(cuid())
  userId         String
  organizationId String
  role           OrgRole  @default(MEMBER)
  joinedAt       DateTime @default(now())

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
}

model OrganizationInvite {
  id             String       @id @default(cuid())
  organizationId String
  email          String
  role           OrgRole      @default(MEMBER)
  token          String       @unique
  invitedById    String
  status         InviteStatus @default(PENDING)

  expiresAt  DateTime
  createdAt  DateTime  @default(now())
  acceptedAt DateTime?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invitedBy    User         @relation(fields: [invitedById], references: [id])
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
  REJECTED
}

model Workspace {
  id             String   @id @default(cuid())
  name           String
  organizationId String
  slug           String   @unique
  iconUrl        String?
  description    String?
  ownerId        String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  owner        User              @relation(fields: [ownerId], references: [id])
  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  members      WorkspaceMember[]
  projects     Project[]
  tasks        Task[]
  invites      WorkspaceInvite[]
  auditLogs    AuditLog[]
}

model WorkspaceMember {
  id          String        @id @default(cuid())
  userId      String
  workspaceId String
  role        WorkspaceRole @default(MEMBER)
  joinedAt    DateTime      @default(now())

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([userId, workspaceId])
}

model WorkspaceInvite {
  id          String        @id @default(cuid())
  workspaceId String
  email       String
  role        WorkspaceRole @default(MEMBER)
  token       String        @unique
  invitedById String
  status      InviteStatus  @default(PENDING)

  expiresAt  DateTime
  createdAt  DateTime  @default(now())
  acceptedAt DateTime?

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  invitedBy User      @relation(fields: [invitedById], references: [id])
}

model Project {
  id          String        @id @default(cuid())
  name        String
  description String?
  status      ProjectStatus @default(ACTIVE)
  nature      ProjectNature @default(PRIVATE)

  workspaceId String
  ownerId     String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  owner     User      @relation(fields: [ownerId], references: [id])

  members        ProjectMember[]
  tasks          Task[]
  taskCategories TaskCategory[]

  @@unique([workspaceId, name])
}

model ProjectMember {
  id        String      @id @default(cuid())
  projectId String
  userId    String
  role      ProjectRole @default(MEMBER)
  joinedAt  DateTime    @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
}

enum ProjectNature {
  PRIVATE
  PUBLIC
}

model Task {
  id          String       @id @default(cuid())
  title       String
  description String?
  status      TaskStatus   @default(TODO)
  priority    TaskPriority @default(MEDIUM)
  deadline    DateTime?
  tag         String?

  workspaceId String
  projectId   String
  categoryId  String?
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  attachments TaskAttachment[]
  links       TaskLink[]
  comments    TaskComment[]

  workspace Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project   Project?      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignees User[]        @relation("TaskAssignees")
  createdBy User          @relation("CreatedTasks", fields: [createdById], references: [id])
  category  TaskCategory? @relation(fields: [categoryId], references: [id])
}

model TaskAttachment {
  id           String  @id @default(cuid())
  taskId       String
  name         String
  url          String
  type         String?
  size         Int?
  uploadedById String

  createdAt DateTime @default(now())

  task       Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  uploadedBy User @relation(fields: [uploadedById], references: [id])
}

model TaskLink {
  id     String  @id @default(cuid())
  taskId String
  title  String?
  url    String

  createdAt DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
}

model TaskComment {
  id      String @id @default(cuid())
  taskId  String
  userId  String
  content String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])
}

model TaskCategory {
  id        String   @id @default(cuid())
  projectId String
  name      String
  color     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks   Task[]

  @@unique([projectId, name])
}

model Plan {
  id          String   @id @default(cuid())
  name        String
  type        PlanType
  description String
  note        String?

  price    Int
  currency String
  interval PlanInterval?

  isActive      Boolean
  isMostPopular Boolean
  features      Json
  limits        Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subscriptions Subscription[]
}

model Subscription {
  id           String             @id @default(cuid())
  userId       String
  planId       String
  status       SubscriptionStatus
  startDate    DateTime
  endDate      DateTime?
  trialEndDate DateTime?
  autoRenew    Boolean            @default(true)
  price        Int
  currency     String
  interval     PlanInterval?
  features     Json
  limits       Json
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  user User @relation(fields: [userId], references: [id])
  plan Plan @relation(fields: [planId], references: [id])
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  EXPIRED
  TRIAL
  PAST_DUE
}

enum PlanInterval {
  MONTH
  YEAR
  LIFETIME
}

enum PlanType {
  FREE
  PRO
  ENTERPRISE
  EARLY_ACCESS
  CUSTOM
  BUSINESS
}

enum UserRole {
  USER
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  BANNED
}

enum OrgRole {
  OWNER
  ADMIN
  MEMBER
}

enum WorkspaceRole {
  OWNER
  ADMIN
  MEMBER
}

enum ProjectStatus {
  DRAFT
  ACTIVE
  ON_HOLD
  BLOCKED
  COMPLETED
  ARCHIVED
  CANCELED
}

enum ProjectRole {
  OWNER
  ADMIN
  MEMBER
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  BLOCKED
  ON_HOLD
  DONE
  CANCELED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum AuditAction {
  ORGANIZATION_CREATE
  ORGANIZATION_UPDATE
  ORGANIZATION_DELETE
  ORGANIZATION_MEMBER_REMOVE
  ORGANIZATION_MEMBER_ROLE_UPDATE
  WORKSPACE_CREATE
  WORKSPACE_UPDATE
  WORKSPACE_DELETE
  WORKSPACE_MEMBER_ADD
  WORKSPACE_MEMBER_ROLE_UPDATE
  WORKSPACE_MEMBER_REMOVE
  PROJECT_CREATE
  PROJECT_UPDATE
  PROJECT_DELETE
  PROJECT_MEMBER_ADD
  PROJECT_MEMBER_REMOVE
  TASK_CREATE
  TASK_UPDATE
  TASK_ASSIGN
  ORGANIZATION_INVITE_SEND
  ORGANIZATION_INVITE_REVOKE
  ORGANIZATION_INVITE_ACCEPT
  ORGANIZATION_INVITE_REJECT
  WORKSPACE_INVITE_SEND
  WORKSPACE_INVITE_REVOKE
  WORKSPACE_INVITE_ACCEPT
  WORKSPACE_INVITE_REJECT
  TASK_COMMENT_CREATE
  TASK_COMMENT_UPDATE
  TASK_COMMENT_DELETE
}

enum AuditEntityType {
  ORGANIZATION
  WORKSPACE
  PROJECT
  TASK
  ORGANIZATION_MEMBER
  WORKSPACE_MEMBER
  PROJECT_MEMBER
  ORGANIZATION_INVITE
  WORKSPACE_INVITE
  COMMENT
}
