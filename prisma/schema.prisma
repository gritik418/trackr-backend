generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                       String     @id @default(cuid())
  name                     String
  username                 String     @unique
  email                    String     @unique
  role                     UserRole   @default(USER)
  isVerified               Boolean    @default(false)
  password                 String
  status                   UserStatus @default(ACTIVE)
  avatarUrl                String?
  avatarPublicId           String?
  verificationToken        String?
  verificationTokenExpiry  DateTime?
  passwordResetToken       String?
  passwordResetTokenExpiry DateTime?
  createdAt                DateTime   @default(now())
  updatedAt                DateTime   @updatedAt

  organizations       Organization[]
  workspaces          Workspace[]
  organizationMembers OrganizationMember[]
  workspaceMembers    WorkspaceMember[]

  taskComments    TaskComment[]
  taskActivities  TaskActivity[]
  taskAttachments TaskAttachment[]

  assignedTasks Task[] @relation("AssignedTasks")
  createdTasks  Task[] @relation("CreatedTasks")
}

model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  logoUrl     String?
  websiteUrl  String?
  description String?
  ownerId     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  owner      User                 @relation(fields: [ownerId], references: [id])
  members    OrganizationMember[]
  workspaces Workspace[]
}

model OrganizationMember {
  id             String   @id @default(cuid())
  userId         String
  organizationId String
  role           OrgRole  @default(MEMBER)
  joinedAt       DateTime @default(now())

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
}

model Workspace {
  id             String   @id @default(cuid())
  name           String
  organizationId String
  slug           String   @unique
  iconUrl        String?
  description    String?
  ownerId        String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  owner          User              @relation(fields: [ownerId], references: [id])
  organization   Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  members        WorkspaceMember[]
  tasks          Task[]
  taskCategories TaskCategory[]
}

model WorkspaceMember {
  id          String        @id @default(cuid())
  userId      String
  workspaceId String
  role        WorkspaceRole @default(MEMBER)
  joinedAt    DateTime      @default(now())

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([userId, workspaceId])
}

model Task {
  id          String       @id @default(cuid())
  title       String
  description String?
  status      TaskStatus   @default(TODO)
  priority    TaskPriority @default(MEDIUM)
  deadline    DateTime?

  workspaceId  String
  assignedToId String?
  categoryId   String?
  createdById  String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  attachments TaskAttachment[]
  links       TaskLink[]
  comments    TaskComment[]
  activities  TaskActivity[]

  workspace  Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  assignedTo User?         @relation("AssignedTasks", fields: [assignedToId], references: [id])
  createdBy  User          @relation("CreatedTasks", fields: [createdById], references: [id])
  category   TaskCategory? @relation(fields: [categoryId], references: [id])
}

model TaskAttachment {
  id           String  @id @default(cuid())
  taskId       String
  name         String
  url          String
  type         String?
  size         Int?
  uploadedById String

  createdAt DateTime @default(now())

  task       Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  uploadedBy User @relation(fields: [uploadedById], references: [id])
}

model TaskLink {
  id     String  @id @default(cuid())
  taskId String
  title  String?
  url    String

  createdAt DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
}

model TaskComment {
  id      String @id @default(cuid())
  taskId  String
  userId  String
  content String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])
}

model TaskActivity {
  id     String           @id @default(cuid())
  taskId String
  userId String
  type   TaskActivityType
  meta   Json?

  createdAt DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])
}

model TaskCategory {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  color       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  tasks     Task[]

  @@unique([workspaceId, name])
}

enum UserRole {
  USER
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  BANNED
}

enum OrgRole {
  OWNER
  ADMIN
  MEMBER
}

enum WorkspaceRole {
  OWNER
  ADMIN
  MEMBER
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  BLOCKED
  ON_HOLD
  DONE
  CANCELED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskActivityType {
  CREATED
  UPDATED

  STATUS_CHANGED

  ASSIGNED
  UNASSIGNED

  PRIORITY_CHANGED
  DEADLINE_CHANGED

  COMMENTED

  ATTACHMENT_ADDED
  ATTACHMENT_REMOVED

  LINK_ADDED
  LINK_REMOVED
}
